generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  user_id     BigInt                  @id @default(autoincrement())
  name        String?
  email       String                  @unique
  password    String
  locale      String                  @default("en") @db.VarChar(45)
  created_at  DateTime                @default(now()) @db.DateTime(0)
  updated_at  DateTime?               @default(now()) @db.DateTime(0)
  plan        Plan                    @default(FREE)
  role        UserRole                @default(USER)
  chats       Chat[]
  events      Event[]
  clicks      MarketplaceClick[]
  impressions MarketplaceImpression[]
  listings    MarketplaceListing[]
  usage       UsageTracker[]
}

model Chat {
  id        BigInt    @id @default(autoincrement())
  title     String?
  userId    BigInt
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  summary   String?   @db.Text
  user      User      @relation(fields: [userId], references: [user_id], onDelete: Cascade)
  messages  Message[]

  @@index([userId])
}

model Message {
  id             BigInt        @id @default(autoincrement())
  chatId         BigInt
  role           Role
  content        String        @db.Text
  audioUrl       String?
  createdAt      DateTime      @default(now())
  fallbackUsed   Boolean?      @default(false)
  idempotencyKey String?       @unique
  refinedPrompt  String?       @db.Text
  status         MessageStatus @default(COMPLETED)
  precis         String?       @db.Text
  failures       FailureLog[]
  chat           Chat          @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([chatId])
}

model Event {
  id               BigInt   @id @default(autoincrement())
  title            String?
  image            String?
  shortDescription String   @db.Text
  time             DateTime
  venue            String
  link             String?
  userId           BigInt?
  published        Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User?    @relation(fields: [userId], references: [user_id])

  @@index([userId])
  @@index([time])
  @@index([published])
}

model FailureLog {
  id           BigInt      @id @default(autoincrement())
  messageId    BigInt
  failureType  FailureType
  errorCode    String?
  errorMessage String      @db.Text
  createdAt    DateTime    @default(now())
  message      Message     @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
}

model UsageTracker {
  id             BigInt    @id @default(autoincrement())
  userId         BigInt
  usageType      UsageType
  count          Int       @default(0)
  cycleStartDate DateTime  @default(now())
  user           User      @relation(fields: [userId], references: [user_id], onDelete: Cascade)

  @@unique([userId, usageType])
}

model MarketplaceListing {
  id          String                  @id @default(cuid())
  url         String
  title       String
  description String
  categories  Json
  keywords    Json
  status      ListingStatus           @default(PENDING)
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
  expiresAt   DateTime?
  userId      BigInt
  clicks      MarketplaceClick[]
  impressions MarketplaceImpression[]
  user        User                    @relation(fields: [userId], references: [user_id], onDelete: Cascade)

  @@index([userId])
}

model MarketplaceImpression {
  id          BigInt             @id @default(autoincrement())
  listingId   String
  userId      BigInt?
  userQuery   String
  impressedAt DateTime           @default(now())
  listing     MarketplaceListing @relation(fields: [listingId], references: [id])
  user        User?              @relation(fields: [userId], references: [user_id])

  @@index([listingId])
  @@index([userId])
}

model MarketplaceClick {
  id        BigInt             @id @default(autoincrement())
  listingId String
  userId    BigInt?
  clickedAt DateTime           @default(now())
  listing   MarketplaceListing @relation(fields: [listingId], references: [id])
  user      User?              @relation(fields: [userId], references: [user_id])

  @@index([listingId])
  @@index([userId])
}

enum Role {
  user
  assistant
}

enum Plan {
  FREE
  PAID
}

enum UserRole {
  USER
  ADMIN
  VENDOR
}

enum ListingStatus {
  ACTIVE
  INACTIVE
  PENDING
  EXPIRED
}

enum FailureType {
  PROMPT_ORCHESTRATION
  CATEGORIZER
  LLM_PRIMARY
  LLM_FALLBACK
  TTS_SERVICE
}

enum UsageType {
  AUDIO_GENERATION
  CHAT_MESSAGES
}

enum MessageStatus {
  PROCESSING
  COMPLETED
  FAILED
}
